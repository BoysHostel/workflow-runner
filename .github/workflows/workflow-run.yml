name: Workflow Runner
on: 
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]
permissions: write-all
jobs:
    run-test-cases:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                    fetch-depth: 0
            - name: Set up Python 3.9
              uses: actions/setup-python@v3
              with:
                    python-version: '3.9'
            - name: Install dependencies
              run: |
                    sudo apt-get install libxml2-utils
                    python -m pip install --upgrade pip
                    pip install pytest
                    pip install coverage
            - name: Test with nosetests
              run: |
                    file=$(git diff HEAD^..HEAD --name-only | cut -d'/' -f1 | uniq )
                    readarray -t services <<< "$file"
                    echo "${services[@]}"
                    PWD="$(pwd)"
                    TEST_COVERAGE=90
                    for service in "${services[@]}"
                    do
                        case "$service" in
                            "workflow")
                                cd $service
                                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                                nosetests --with-coverage --cover-erase --cover-package=. --cover-tests --cover-xml
                                coverage=$(echo 'cat //coverage/@line-rate' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                coverage_percent=$(echo $coverage*100 | bc)
                                total=$(echo 'cat //coverage/@lines-valid' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                covered=$(echo 'cat //coverage/@lines-covered' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                curl --request POST --url https://api.github.com/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/comments --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' --header 'content-type: application/json' --data "{\"body\": \"<table><thead><tr><td>Total Lines</td><td>Covered</td><td>Coverage</td></tr></thead><tbody><tr><td> $total </td><td> $covered </td><td> $coverage_percent %</td></tr></tbody></table>\"}" --fail
                                cd ..
                                ;;
                            "workflow_1")
                                cd $service
                                echo "$latest_commit_sha"
                                if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                                nosetests --with-coverage --cover-erase --cover-package=. --cover-tests --cover-xml
                                coverage=$(echo 'cat //coverage/@line-rate' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                coverage_percent=$(echo $coverage*100 | bc)
                                total=$(echo 'cat //coverage/@lines-valid' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                covered=$(echo 'cat //coverage/@lines-covered' | xmllint --shell coverage.xml | awk -F'[="]' '!/>/{print $(NF-1)}')
                                curl --request POST --url https://api.github.com/repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/comments --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' --header 'content-type: application/json' --data "{\"body\": \"<table><thead><tr><td>Total Lines</td><td>Covered</td><td>Coverage</td></tr></thead><tbody><tr><td> $total </td><td> $covered </td><td> $coverage_percent %</td></tr></tbody></table>\"}" --fail
                                cd ..
                                ;;
                            *)
                                echo "Testcase Action not implemented for {$service}"
                        esac
                    done
